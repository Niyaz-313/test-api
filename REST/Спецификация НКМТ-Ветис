openapi: 3.0.3
info:
  title: API интеграции НКМТ и ВетИС
  description: |
    REST API для асинхронного взаимодействия между Национальным Каталогом Маркированных Товаров (НКМТ)
    и ветеринарной информационной системой (ВетИС) для синхронизации данных о продукции.
    
    ## Основные принципы:
    1. Все операции асинхронные
    2. Для каждого запроса возвращается requestId для отслеживания статуса
    3. Поддерживаются все типы операций согласно концепции взаимодействия
    
    ## Типы операций:
    - TYPE.01 - TYPE.15: Операции синхронизации номенклатур
    - INT.02 - INT.06: Специальные интеграционные операции
    
    **Для тестирования используйте:** http://localhost:8080
  version: 1.0.0
  contact:
    name: Техническая поддержка ВетИС
    email: support@vetis.ru
    url: https://vetis.ru/support
  license:
    name: Proprietary
    url: https://vetis.ru/license

servers:
  - url: http://localhost:8080
    description: Локальный сервер для разработки (с CORS)
  - url: https://vetis-api-test.ru
    description: Тестовый сервер
  - url: https://vetis-api-dev.ru
    description: Сервер разработки
  - url: https://vetis-api.ru
    description: Продуктивный сервер

tags:
  - name: requests
    description: Операции управления запросами синхронизации
  - name: status
    description: Операции проверки статуса запросов
  - name: health
    description: Проверка работоспособности API

paths:
  /api/v1/requests:
    post:
      tags:
        - requests
      summary: Создание нового запроса на синхронизацию данных
      description: |
        Метод для инициации асинхронной операции синхронизации данных между НКМТ и ВетИС.
        Поддерживает все типы операций (TYPE.01-TYPE.15, INT.02, INT.03, INT.05, INT.06).
        
        **Важно:** Запрос обрабатывается асинхронно. В ответе возвращается идентификатор запроса (requestId)
        для последующей проверки статуса через GET /api/v1/requests/{requestId}.
        
        ## Обязательные поля для каждого типа операции:
        
        | Тип операции | Обязательные поля |
        |-------------|-------------------|
        | TYPE.01 | ownerInn, gtin |
        | TYPE.02 | ownerInn, gtin, productItemId |
        | TYPE.03 | ownerInn, gtin |
        | TYPE.04 | ownerInn, gtin, status |
        | TYPE.05 | ownerInn, newOwnerInn, gtin |
        | TYPE.06 | ownerInn, gtin, subaccounts |
        | TYPE.07 | ownerInn, gtin, subaccounts |
        | TYPE.08 | ownerInn, gtin, status, subaccounts |
        | TYPE.09 | ownerInn, gtin, status, subaccounts |
        | TYPE.10 | ownerInn, gtin, subaccounts |
        | TYPE.11 | ownerInn, gtin, status, subaccounts, productItemId, uuid |
        | TYPE.12 | ownerInn, gtin, status, subaccounts |
        | TYPE.15 | ownerInn, gtin, status |
        | INT.02 | ownerInn, gtin, productItemId |
        | INT.03 | ownerInn, validationType, cardStatus |
        | INT.05 | productItemId |
        | INT.06 | ownerInn, gtin, subaccounts |
      operationId: createSyncRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestPayload'
            examples:
              type01_example:
                summary: TYPE.01 - Новый GTIN
                value:
                  operationType: "TYPE.01"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    status: "Черновик"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    sourceSystem: "NKMT"
                    userAction: "CREATE_PRODUCT_CARD"
                    requestSource: "USER"
              type02_example:
                summary: TYPE.02 - Новый GTIN (Подтверждено УОТом)
                value:
                  operationType: "TYPE.02"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    productItemId: "550e8400-e29b-41d4-a716-446655440000"
                    uuid: "550e8400-e29b-41d4-a716-446655440001"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "CONFIRM_NOMENCLATURE"
              type03_example:
                summary: TYPE.03 - Изменение атрибутов GTIN
                value:
                  operationType: "TYPE.03"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "UPDATE_PRODUCT_ATTRIBUTES"
              type04_example:
                summary: TYPE.04 - Изменение статуса GTIN
                value:
                  operationType: "TYPE.04"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    status: "Опубликована"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "CHANGE_PRODUCT_STATUS"
              type05_example:
                summary: TYPE.05 - Изменение ИНН владельца GTIN с субаккаунтами
                value:
                  operationType: "TYPE.05"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    newOwnerInn: "1111111111"
                    gtin: ["04630012345678", "04630087654321"]
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "CHANGE_OWNER_INN"
              type06_example:
                summary: TYPE.06 - Новый субаккаунт (карточка в статусе "Черновик")
                value:
                  operationType: "TYPE.06"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                    subaccountsAction: "ADD"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "ADD_SUBACCOUNT"
              type07_example:
                summary: TYPE.07 - Изменение атрибутов GTIN с субаккаунтами
                value:
                  operationType: "TYPE.07"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                      - inn: "1122334455"
                        kpp: "667788990"
                    subaccountsAction: "REPLACE"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "UPDATE_PRODUCT_WITH_SUBACCOUNTS"
              type08_example:
                summary: TYPE.08 - Публикация карточки GTIN с субаккаунтами
                value:
                  operationType: "TYPE.08"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    status: "Опубликована"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "PUBLISH_PRODUCT_WITH_SUBACCOUNTS"
              type09_example:
                summary: TYPE.09 - Новый субаккаунт (карточка в статусе "Опубликована")
                value:
                  operationType: "TYPE.09"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    status: "Опубликована"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                    subaccountsAction: "ADD"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "ADD_SUBACCOUNT_TO_PUBLISHED"
              type10_example:
                summary: TYPE.10 - Блокировка субаккаунта
                value:
                  operationType: "TYPE.10"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                        action: "BLOCK"
                    subaccountsAction: "REMOVE"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "BLOCK_SUBACCOUNT"
              type11_example:
                summary: TYPE.11 - Публикация карточки GTIN с атрибутами и субаккаунтами
                value:
                  operationType: "TYPE.11"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    status: "Опубликована"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                    productItemId: "550e8400-e29b-41d4-a716-446655440000"
                    uuid: "550e8400-e29b-41d4-a716-446655440001"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "PUBLISH_WITH_ATTRIBUTES_AND_SUBACCOUNTS"
              type12_example:
                summary: TYPE.12 - Аннулирование GTIN с субаккаунтами
                value:
                  operationType: "TYPE.12"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    status: "Аннулирована"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "ANNULATE_PRODUCT"
              type15_example:
                summary: TYPE.15 - Изменение атрибутов и статуса GTIN
                value:
                  operationType: "TYPE.15"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    status: "Опубликована"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "UPDATE_ATTRIBUTES_AND_STATUS"
              int02_example:
                summary: INT.02 - Привязка существующей номенклатуры к карточке
                value:
                  operationType: "INT.02"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    productItemId: "550e8400-e29b-41d4-a716-446655440000"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "BIND_NOMENCLATURE"
              int03_historical_example:
                summary: INT.03 - Проверка версии номенклатуры (исторические данные)
                value:
                  operationType: "INT.03"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    validationType: "HISTORICAL"
                    cardStatus: "MODERATION"
                    productItemId: "550e8400-e29b-41d4-a716-446655440000"
                    uuid: "550e8400-e29b-41d4-a716-446655440001"
                    subaccountInn: "0987654321"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "VALIDATE_HISTORICAL_VERSION"
              int03_new_example:
                summary: INT.03 - Проверка версии номенклатуры (новые данные)
                value:
                  operationType: "INT.03"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    validationType: "NEW"
                    cardStatus: "MODERATION"
                    gtin: "04630012345678"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "VALIDATE_NEW_VERSION"
              int03_sub_example:
                summary: INT.03_SUB - Поиск номенклатуры субаккаунта
                value:
                  operationType: "INT.03_SUB"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: "04630012345678"
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "SEARCH_SUBACCOUNT_NOMENCLATURE"
              int05_example:
                summary: INT.05 - Получение атрибутов номенклатуры по ProductItem ID
                value:
                  operationType: "INT.05"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    productItemId: "550e8400-e29b-41d4-a716-446655440000"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "GET_NOMENCLATURE_ATTRIBUTES"
              int06_example:
                summary: INT.06 - Обновление номенклатуры субаккаунтов при изменениях GTIN
                value:
                  operationType: "INT.06"
                  initiatedAt: "2024-01-15T10:30:00Z"
                  payload:
                    ownerInn: "1234567890"
                    gtin: ["04630012345678", "04630087654321"]
                    subaccounts:
                      - inn: "0987654321"
                        kpp: "123456789"
                        action: "ACTIVATE"
                      - inn: "1122334455"
                        kpp: "667788990"
                        action: "DEACTIVATE"
                  metadata:
                    userId: "user123"
                    sessionId: "session-abc"
                    userAction: "UPDATE_SUBACCOUNTS_ON_GTIN_CHANGE"
      responses:
        '202':
          description: Запрос успешно принят в обработку
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestAcceptedResponse'
              examples:
                success:
                  summary: Успешный ответ
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    status: "ACCEPTED"
                    message: "Запрос принят в обработку"
                    timestamp: "2024-01-15T10:30:01Z"
                    estimatedProcessingTime: 300
                    statusCheckUrl: "http://localhost:8080/api/v1/requests/550e8400-e29b-41d4-a716-446655440000"
                    nextStatusCheckAfter: "2024-01-15T10:35:00Z"
                    operationType: "TYPE.01"
        '400':
          description: Неверный формат запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  summary: Ошибка валидации
                  value:
                    errorCode: "VALIDATION_ERROR"
                    message: "Неверный формат запроса"
                    details: "Поле 'ownerInn' обязательно для операции TYPE.01"
                    timestamp: "2024-01-15T10:30:01Z"
        '401':
          description: Неавторизованный доступ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Превышен лимит запросов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rate_limit:
                  summary: Превышение лимита
                  value:
                    errorCode: "RATE_LIMIT_EXCEEDED"
                    message: "Превышен лимит запросов"
                    details: "Допустимо не более 100 запросов в минуту"
                    timestamp: "2024-01-15T10:30:01Z"
                    retryAfter: 60
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Сервис временно недоступен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                service_unavailable:
                  summary: Сервис недоступен
                  value:
                    errorCode: "SERVICE_UNAVAILABLE"
                    message: "Сервис временно недоступен"
                    details: "Ведутся технические работы. Повторите запрос позже."
                    timestamp: "2024-01-15T10:30:01Z"
                    retryAfter: 300
      security:
        - apiKey: []
        - bearerAuth: []

  /api/v1/requests/{requestId}:
    get:
      tags:
        - status
      summary: Получение статуса и результатов обработки запроса
      description: |
        Метод для проверки статуса обработки асинхронного запроса.
        Возвращает текущий статус, прогресс обработки и результаты (в случае завершения).
        
        **Опциональные параметры:**
        - `includeDetails` - включить детальную информацию о шагах обработки
        - `waitForCompletion` - ожидать завершения обработки (макс. 30 секунд)
      operationId: getRequestStatus
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор запроса, полученный при создании
        - name: includeDetails
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Включить детальную информацию о шагах обработки
        - name: waitForCompletion
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 30
            default: 0
          description: Время ожидания завершения обработки (секунды, максимум 30)
      responses:
        '200':
          description: Информация о статусе запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestStatusResponse'
              examples:
                pending:
                  summary: Запрос в очереди
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "PENDING"
                    message: "Запрос находится в очереди на обработку"
                    progress: 0
                    currentStep: "QUEUED"
                    createdAt: "2024-01-15T10:30:00Z"
                    updatedAt: "2024-01-15T10:30:00Z"
                    estimatedCompletionAt: "2024-01-15T10:35:00Z"
                in_progress:
                  summary: Запрос в обработке
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "IN_PROGRESS"
                    progress: 60
                    currentStep: "VALIDATING_DATA"
                    message: "Идет валидация данных в системе Меркурий"
                    createdAt: "2024-01-15T10:30:00Z"
                    updatedAt: "2024-01-15T10:31:00Z"
                    estimatedCompletionAt: "2024-01-15T10:35:00Z"
                    details:
                      processedItems: 1
                      totalItems: 1
                      stepDetails:
                        name: "Валидация данных"
                        description: "Проверка справочных значений уровней позиционирования"
                        startedAt: "2024-01-15T10:30:45Z"
                completed_success:
                  summary: Запрос успешно завершен
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "COMPLETED_SUCCESS"
                    message: "Номенклатура успешно создана в системе Меркурий"
                    createdAt: "2024-01-15T10:30:00Z"
                    completedAt: "2024-01-15T10:34:30Z"
                    results:
                      summary:
                        totalProcessed: 1
                        successful: 1
                        failed: 0
                        warnings: 0
                      items:
                        - gtin: "04630012345678"
                          status: "SUCCESS"
                          mercuryId: "MERC-12345-ABCD"
                          productItemId: "550e8400-e29b-41d4-a716-446655440001"
                          uuid: "550e8400-e29b-41d4-a716-446655440002"
                          action: "CREATED"
                          timestamp: "2024-01-15T10:34:15Z"
                          details: "Номенклатура создана со статусом 'Черновик'"
                    details:
                      mercuryBatchId: "BATCH-2024-001"
                      processingTimeMs: 270000
                completed_with_errors:
                  summary: Запрос завершен с ошибками
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "COMPLETED_WITH_ERRORS"
                    message: "Найдено несколько номенклатур для указанного GTIN"
                    createdAt: "2024-01-15T10:30:00Z"
                    completedAt: "2024-01-15T10:32:45Z"
                    results:
                      summary:
                        totalProcessed: 1
                        successful: 0
                        failed: 1
                        warnings: 0
                      items:
                        - gtin: "04630012345678"
                          status: "FAILED"
                          timestamp: "2024-01-15T10:32:30Z"
                          error:
                            code: "DUPLICATE_NOMENCLATURE"
                            message: "Найдено несколько номенклатур для GTIN"
                            details: "Для GTIN 04630012345678 найдено 3 номенклатуры"
                            severity: "BLOCKER"
                            resolution: "CHOOSE_PRODUCT_ITEM"
                            productItemIds:
                              - "550e8400-e29b-41d4-a716-446655440001"
                              - "550e8400-e29b-41d4-a716-446655440002"
                              - "550e8400-e29b-41d4-a716-446655440003"
                failed:
                  summary: Запрос завершился неудачей
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "FAILED"
                    message: "Ошибка валидации данных"
                    createdAt: "2024-01-15T10:30:00Z"
                    failedAt: "2024-01-15T10:31:15Z"
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Указанное справочное значение отсутствует в системе"
                      details: "Справочное значение 'Молоко пастеризованное' не найдено в справочнике продукции ВетИС"
                      severity: "ERROR"
                      retryable: true
                      suggestedRetryAfter: "2024-01-15T11:00:00Z"
                retrying:
                  summary: Повторная попытка обработки
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "RETRYING"
                    message: "Повторная попытка обработки после технической ошибки"
                    progress: 30
                    currentStep: "RETRY"
                    createdAt: "2024-01-15T10:30:00Z"
                    updatedAt: "2024-01-15T10:32:00Z"
                    estimatedCompletionAt: "2024-01-15T10:38:00Z"
                    details:
                      retryCount: 2
                      maxRetries: 5
                      lastError: "Сервис Меркурий временно недоступен"
                cancelled:
                  summary: Запрос отменен
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "CANCELLED"
                    message: "Запрос отменен пользователем"
                    createdAt: "2024-01-15T10:30:00Z"
                    completedAt: "2024-01-15T10:31:30Z"
                    details:
                      cancelledBy: "user123"
                      cancelledAt: "2024-01-15T10:31:30Z"
                      reason: "Ошибка в исходных данных"
                timeout:
                  summary: Превышено время обработки
                  value:
                    requestId: "550e8400-e29b-41d4-a716-446655440000"
                    operationType: "TYPE.01"
                    status: "TIMEOUT"
                    message: "Превышено максимальное время обработки запроса"
                    createdAt: "2024-01-15T10:30:00Z"
                    failedAt: "2024-01-15T10:45:00Z"
                    error:
                      code: "TIMEOUT"
                      message: "Превышено время обработки запроса"
                      details: "Максимальное время обработки - 15 минут"
                      severity: "ERROR"
                      retryable: true
        '400':
          description: Неверный формат запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Неавторизованный доступ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Запрос не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Запрос не найден
                  value:
                    errorCode: "REQUEST_NOT_FOUND"
                    message: "Запрос с указанным идентификатором не найден"
                    details: "Запрос 550e8400-e29b-41d4-a716-446655440000 не существует или был удален"
                    timestamp: "2024-01-15T10:30:01Z"
        '410':
          description: Результаты запроса были очищены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                gone:
                  summary: Результаты удалены
                  value:
                    errorCode: "REQUEST_EXPIRED"
                    message: "Результаты запроса были очищены"
                    details: "Результаты запроса хранятся 30 дней. Запрос был создан 2023-12-01T10:30:00Z"
                    timestamp: "2024-01-15T10:30:01Z"
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - apiKey: []
        - bearerAuth: []

  /api/v1/requests:
    get:
      tags:
        - requests
      summary: Поиск запросов по критериям
      description: |
        Метод для поиска запросов по различным критериям фильтрации.
        Поддерживает пагинацию и сортировку.
      operationId: searchRequests
      parameters:
        - name: operationType
          in: query
          required: false
          schema:
            type: string
          description: Фильтр по типу операции
        - name: status
          in: query
          required: false
          schema:
            type: string
          description: Фильтр по статусу запроса
        - name: ownerInn
          in: query
          required: false
          schema:
            type: string
          description: Фильтр по ИНН владельца
        - name: createdAfter
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Запросы созданные после указанной даты
        - name: createdBefore
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Запросы созданные до указанной даты
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Номер страницы (начиная с 1)
        - name: pageSize
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Размер страницы (1-100)
        - name: sortBy
          in: query
          required: false
          schema:
            type: string
            enum: [createdAt, updatedAt, status]
            default: "createdAt"
          description: Поле для сортировки
        - name: sortOrder
          in: query
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: "desc"
          description: Порядок сортировки
      responses:
        '200':
          description: Список запросов
          content:
            application/json:
              schema:
                type: object
                properties:
                  requests:
                    type: array
                    items:
                      $ref: '#/components/schemas/RequestStatusResponse'
                  pagination:
                    $ref: '#/components/schemas/PaginationInfo'
        '400':
          description: Неверные параметры запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Неавторизованный доступ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - apiKey: []
        - bearerAuth: []

  /api/v1/requests/{requestId}/cancel:
    post:
      tags:
        - requests
      summary: Отмена запроса
      description: |
        Метод для отмены запроса, который еще не начал обрабатываться или находится в обработке.
        Не все запросы могут быть отменены (например, уже завершенные).
      operationId: cancelRequest
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Идентификатор запроса для отмены
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Причина отмены
                initiatedBy:
                  type: string
                  description: Идентификатор пользователя, инициировавшего отмену
      responses:
        '200':
          description: Запрос успешно отменен
          content:
            application/json:
              schema:
                type: object
                properties:
                  requestId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [CANCELLED]
                  message:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
        '400':
          description: Невозможно отменить запрос
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Запрос не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - apiKey: []
        - bearerAuth: []

  /api/v1/health:
    get:
      tags:
        - health
      summary: Проверка работоспособности API
      description: |
        Метод для проверки доступности и работоспособности API.
        Возвращает текущий статус сервиса и информацию о версии.
      operationId: healthCheck
      responses:
        '200':
          description: Сервис работает
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [UP, DOWN]
                  version:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
                  services:
                    type: object
                    properties:
                      vetisApi:
                        type: object
                        properties:
                          status:
                            type: string
                          responseTimeMs:
                            type: integer
                      mercury:
                        type: object
                        properties:
                          status:
                            type: string
                          responseTimeMs:
                            type: integer
              examples:
                healthy:
                  summary: Сервис работает
                  value:
                    status: "UP"
                    version: "1.0.0"
                    timestamp: "2024-01-15T10:30:00Z"
                    services:
                      vetisApi:
                        status: "UP"
                        responseTimeMs: 45
                      mercury:
                        status: "UP"
                        responseTimeMs: 120
        '503':
          description: Сервис недоступен
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [DOWN]
                  timestamp:
                    type: string
                    format: date-time
                  message:
                    type: string
                  details:
                    type: string
              examples:
                unhealthy:
                  summary: Сервис недоступен
                  value:
                    status: "DOWN"
                    timestamp: "2024-01-15T10:30:00Z"
                    message: "Сервис временно недоступен"
                    details: "Ведутся технические работы"

components:
  schemas:
    RequestPayload:
      type: object
      required:
        - operationType
        - initiatedAt
        - payload
      properties:
        operationType:
          type: string
          enum:
            - TYPE.01
            - TYPE.02
            - TYPE.03
            - TYPE.04
            - TYPE.05
            - TYPE.06
            - TYPE.07
            - TYPE.08
            - TYPE.09
            - TYPE.10
            - TYPE.11
            - TYPE.12
            - TYPE.15
            - INT.02
            - INT.03
            - INT.03_SUB
            - INT.05
            - INT.06
          description: Тип операции согласно спецификации
          example: "TYPE.01"
        initiatedAt:
          type: string
          format: date-time
          description: Дата и время инициации запроса в НКМТ
          example: "2024-01-15T10:30:00Z"
        payload:
          $ref: '#/components/schemas/OperationPayload'
        callbackUrl:
          type: string
          format: uri
          description: URL для callback уведомлений (опционально)
          example: "https://nkmt-api.ru/callbacks/status"
        metadata:
          $ref: '#/components/schemas/RequestMetadata'

    OperationPayload:
      type: object
      properties:
        ownerInn:
          type: string
          pattern: '^\d{10}|\d{12}$'
          description: ИНН владельца GTIN (10 или 12 цифр)
          example: "1234567890"
        newOwnerInn:
          type: string
          pattern: '^\d{10}|\d{12}$'
          description: Новый ИНН владельца (для операций реорганизации)
          example: "1111111111"
        gtin:
          oneOf:
            - type: string
              pattern: '^\d{14}$'
              description: Один GTIN (14 цифр)
              example: "04630012345678"
            - type: array
              items:
                type: string
                pattern: '^\d{14}$'
              description: Список GTIN
              example: ["04630012345678", "04630087654321"]
        productItemId:
          type: string
          format: uuid
          description: GUID номенклатуры из ВетИС (ProductItem.guid)
          example: "550e8400-e29b-41d4-a716-446655440000"
        uuid:
          type: string
          format: uuid
          description: UUID версии номенклатуры из ВетИС
          example: "550e8400-e29b-41d4-a716-446655440001"
        productItemIds:
          type: array
          items:
            type: string
            format: uuid
          description: Список GUID номенклатур для выбора УОТом
          example: ["550e8400-e29b-41d4-a716-446655440001", "550e8400-e29b-41d4-a716-446655440002"]
        status:
          type: string
          enum:
            - Черновик
            - На_модерации
            - Требует_изменений
            - Ожидает_подписания
            - Опубликована
            - В_архиве
            - Аннулирована
          description: Статус карточки/номенклатуры
          example: "Черновик"
        subaccounts:
          type: array
          items:
            $ref: '#/components/schemas/Subaccount'
          description: Список субаккаунтов
        subaccountsAction:
          type: string
          enum: [ADD, REPLACE, REMOVE]
          description: Действие со списком субаккаунтов
          example: "ADD"
        validationType:
          type: string
          enum: [HISTORICAL, NEW]
          description: Тип проверки версии (для INT.03)
          example: "HISTORICAL"
        cardStatus:
          type: string
          enum: [MODERATION, SIGNED]
          description: Статус карточки для проверки версии
          example: "MODERATION"
        positioningLevels:
          $ref: '#/components/schemas/PositioningLevels'
        requestId:
          type: string
          description: Идентификатор запроса для обновления
          example: "req_12345"
        stpTicketId:
          type: string
          description: Номер обращения в СТП Меркурий
          example: "STP-12345"
        subaccountInn:
          type: string
          pattern: '^\d{10}|\d{12}$'
          description: ИНН субаккаунта (для INT.03)
          example: "0987654321"

    Subaccount:
      type: object
      required: [inn]
      properties:
        inn:
          type: string
          pattern: '^\d{10}|\d{12}$'
          description: ИНН субаккаунта
          example: "0987654321"
        kpp:
          type: string
          pattern: '^\d{9}$'
          description: КПП субаккаунта
          example: "123456789"
        action:
          type: string
          enum: [ACTIVATE, DEACTIVATE, BLOCK]
          description: Действие для субаккаунта
          example: "ACTIVATE"

    PositioningLevels:
      type: object
      properties:
        level1:
          type: string
          description: Уровень 1 - тип продукции
          example: "Молоко и молочная продукция"
        level2:
          type: string
          description: Уровень 2 - продукция
          example: "Молоко питьевое"
        level3:
          type: string
          description: Уровень 3 - вид продукции
          example: "Молоко питьевое пастеризованное"
        level4:
          type: string
          description: Уровень 4 - номенклатура
          example: "Молоко пастеризованное 3,2%"

    RequestMetadata:
      type: object
      properties:
        userId:
          type: string
          description: Идентификатор пользователя в НКМТ
          example: "user123"
        sessionId:
          type: string
          description: Идентификатор сессии
          example: "session-abc-123"
        sourceSystem:
          type: string
          default: "NKMT"
          example: "NKMT"
        userAction:
          type: string
          description: Действие пользователя (создание, изменение, публикация и т.д.)
          example: "CREATE_PRODUCT_CARD"
        requestSource:
          type: string
          enum: [USER, MODERATOR, STP, SYSTEM]
          default: "USER"
          example: "USER"

    RequestAcceptedResponse:
      type: object
      required:
        - requestId
        - status
        - timestamp
      properties:
        requestId:
          type: string
          format: uuid
          description: Идентификатор созданного запроса
          example: "550e8400-e29b-41d4-a716-446655440000"
        status:
          type: string
          enum: [ACCEPTED]
          description: Статус запроса
          example: "ACCEPTED"
        message:
          type: string
          description: Сообщение для пользователя
          example: "Запрос принят в обработку"
        timestamp:
          type: string
          format: date-time
          description: Время формирования ответа
          example: "2024-01-15T10:30:01Z"
        estimatedProcessingTime:
          type: integer
          minimum: 0
          description: Оценочное время обработки в секундах
          example: 300
        statusCheckUrl:
          type: string
          format: uri
          description: URL для проверки статуса
          example: "https://vetis-api.ru/api/v1/requests/550e8400-e29b-41d4-a716-446655440000"
        nextStatusCheckAfter:
          type: string
          format: date-time
          description: Рекомендуемое время следующей проверки статуса
          example: "2024-01-15T10:35:00Z"
        operationType:
          type: string
          description: Тип операции запроса
          example: "TYPE.01"

    RequestStatusResponse:
      type: object
      required:
        - requestId
        - operationType
        - status
        - createdAt
      properties:
        requestId:
          type: string
          format: uuid
          description: Идентификатор запроса
          example: "550e8400-e29b-41d4-a716-446655440000"
        operationType:
          type: string
          description: Тип операции запроса
          example: "TYPE.01"
        status:
          type: string
          enum:
            - PENDING
            - IN_PROGRESS
            - COMPLETED_SUCCESS
            - COMPLETED_WITH_ERRORS
            - FAILED
            - CANCELLED
            - TIMEOUT
            - RETRYING
          description: Текущий статус обработки запроса
          example: "IN_PROGRESS"
        message:
          type: string
          description: Человекочитаемое сообщение о статусе
          example: "Идет валидация данных в системе Меркурий"
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Процент выполнения (0-100)
          example: 60
        currentStep:
          type: string
          description: Текущий шаг обработки
          example: "VALIDATING_DATA"
        createdAt:
          type: string
          format: date-time
          description: Время создания запроса
          example: "2024-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Время последнего обновления статуса
          example: "2024-01-15T10:31:00Z"
        completedAt:
          type: string
          format: date-time
          description: Время завершения обработки
          example: "2024-01-15T10:34:30Z"
        failedAt:
          type: string
          format: date-time
          description: Время возникновения ошибки
          example: "2024-01-15T10:31:15Z"
        estimatedCompletionAt:
          type: string
          format: date-time
          description: Оценочное время завершения обработки
          example: "2024-01-15T10:35:00Z"
        details:
          $ref: '#/components/schemas/ProcessingDetails'
        results:
          $ref: '#/components/schemas/ProcessingResults'
        error:
          $ref: '#/components/schemas/ProcessingError'

    ProcessingDetails:
      type: object
      properties:
        processedItems:
          type: integer
          minimum: 0
          description: Количество обработанных элементов
          example: 1
        totalItems:
          type: integer
          minimum: 0
          description: Общее количество элементов для обработки
          example: 1
        stepDetails:
          type: object
          properties:
            name:
              type: string
              description: Название текущего шага
              example: "Валидация данных"
            description:
              type: string
              description: Описание шага
              example: "Проверка справочных значений уровней позиционирования"
            startedAt:
              type: string
              format: date-time
              description: Время начала шага
              example: "2024-01-15T10:30:45Z"
            completedAt:
              type: string
              format: date-time
              description: Время завершения шага
              example: "2024-01-15T10:31:15Z"
        mercuryBatchId:
          type: string
          description: Идентификатор пакета в системе Меркурий
          example: "BATCH-2024-001"
        stpTicketId:
          type: string
          description: Номер обращения в СТП Меркурий (если создано)
          example: "STP-12345"
        processingTimeMs:
          type: integer
          description: Время обработки в миллисекундах
          example: 270000
        retryCount:
          type: integer
          description: Количество попыток повторной обработки
          example: 2
        maxRetries:
          type: integer
          description: Максимальное количество попыток
          example: 5
        lastError:
          type: string
          description: Последняя ошибка (при RETRYING статусе)
          example: "Сервис Меркурий временно недоступен"
        cancelledBy:
          type: string
          description: Пользователь, отменивший запрос
          example: "user123"
        cancelledAt:
          type: string
          format: date-time
          description: Время отмены запроса
          example: "2024-01-15T10:31:30Z"
        reason:
          type: string
          description: Причина отмены
          example: "Ошибка в исходных данных"

    ProcessingResults:
      type: object
      properties:
        summary:
          $ref: '#/components/schemas/ResultsSummary'
        items:
          type: array
          items:
            $ref: '#/components/schemas/ResultItem'
          description: Детальные результаты по элементам
        partialSuccess:
          type: array
          items:
            $ref: '#/components/schemas/ResultItem'
          description: Частично успешные результаты
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/Warning'
          description: Предупреждения

    ResultsSummary:
      type: object
      required:
        - totalProcessed
        - successful
        - failed
      properties:
        totalProcessed:
          type: integer
          minimum: 0
          description: Всего обработано элементов
          example: 1
        successful:
          type: integer
          minimum: 0
          description: Успешно обработано
          example: 1
        failed:
          type: integer
          minimum: 0
          description: Завершилось ошибкой
          example: 0
        warnings:
          type: integer
          minimum: 0
          description: Количество предупреждений
          example: 0

    ResultItem:
      type: object
      required:
        - gtin
        - status
      properties:
        gtin:
          type: string
          pattern: '^\d{14}$'
          description: GTIN товара
          example: "04630012345678"
        status:
          type: string
          enum: [SUCCESS, FAILED, PARTIAL, WARNING]
          description: Статус обработки элемента
          example: "SUCCESS"
        mercuryId:
          type: string
          description: Идентификатор в системе Меркурий
          example: "MERC-12345-ABCD"
        productItemId:
          type: string
          format: uuid
          description: GUID номенклатуры
          example: "550e8400-e29b-41d4-a716-446655440001"
        uuid:
          type: string
          format: uuid
          description: UUID версии номенклатуры
          example: "550e8400-e29b-41d4-a716-446655440002"
        action:
          type: string
          enum: [CREATED, UPDATED, BLOCKED, UNBLOCKED, DELETED, SYNCHRONIZED]
          description: Выполненное действие
          example: "CREATED"
        timestamp:
          type: string
          format: date-time
          description: Время выполнения действия
          example: "2024-01-15T10:34:15Z"
        details:
          type: string
          description: Детальное описание результата
          example: "Номенклатура создана со статусом 'Черновик'"
        error:
          $ref: '#/components/schemas/ProcessingError'

    Warning:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Код предупреждения
          example: "DEPRECATED_VALUE"
        message:
          type: string
          description: Текст предупреждения
          example: "Используется устаревшее справочное значение"
        details:
          type: string
          description: Детали предупреждения
          example: "Значение будет удалено из справочника 2024-06-01"
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH]
          description: Уровень серьезности
          example: "LOW"

    ProcessingError:
      type: object
      required:
        - code
        - message
        - severity
      properties:
        code:
          type: string
          enum:
            - VALIDATION_ERROR
            - DUPLICATE_NOMENCLATURE
            - SYSTEM_UNAVAILABLE
            - TECHNICAL_ERROR
            - NOT_FOUND
            - UNAUTHORIZED
            - TIMEOUT
            - RATE_LIMIT_EXCEEDED
            - REQUEST_NOT_FOUND
            - REQUEST_EXPIRED
            - SERVICE_UNAVAILABLE
          description: Код ошибки
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Текст ошибки
          example: "Указанное справочное значение отсутствует в системе"
        details:
          type: string
          description: Детальное описание ошибки
          example: "Справочное значение 'Молоко пастеризованное' не найдено в справочнике продукции ВетИС"
        severity:
          type: string
          enum: [INFO, WARNING, ERROR, BLOCKER]
          description: Уровень серьезности ошибки
          example: "ERROR"
        retryable:
          type: boolean
          description: Можно ли повторить запрос
          example: true
        suggestedRetryAfter:
          type: string
          format: date-time
          description: Рекомендуемое время повторной попытки
          example: "2024-01-15T11:00:00Z"
        resolution:
          type: string
          enum: [RETRY, CONTACT_STP, UPDATE_DATA, CHOOSE_PRODUCT_ITEM]
          description: Рекомендуемое действие для разрешения
          example: "UPDATE_DATA"
        stpTicketId:
          type: string
          description: Номер обращения в СТП (если создано)
          example: "STP-12345"
        productItemIds:
          type: array
          items:
            type: string
            format: uuid
          description: Список GUID номенклатур для выбора (при DUPLICATE_NOMENCLATURE)
          example: ["550e8400-e29b-41d4-a716-446655440001", "550e8400-e29b-41d4-a716-446655440002"]

    ErrorResponse:
      type: object
      required:
        - errorCode
        - message
        - timestamp
      properties:
        errorCode:
          type: string
          description: Код ошибки
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Сообщение об ошибке
          example: "Неверный формат запроса"
        details:
          type: string
          description: Детали ошибки
          example: "Поле 'ownerInn' обязательно для операции TYPE.01"
        timestamp:
          type: string
          format: date-time
          description: Время возникновения ошибки
          example: "2024-01-15T10:30:01Z"
        retryAfter:
          type: integer
          description: Время в секундах до следующей попытки
          example: 60

    PaginationInfo:
      type: object
      properties:
        page:
          type: integer
          description: Текущая страница
          example: 1
        pageSize:
          type: integer
          description: Размер страницы
          example: 20
        totalPages:
          type: integer
          description: Общее количество страниц
          example: 5
        totalItems:
          type: integer
          description: Общее количество элементов
          example: 95
        hasNext:
          type: boolean
          description: Есть следующая страница
          example: true
        hasPrevious:
          type: boolean
          description: Есть предыдущая страница
          example: false

  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: API ключ для аутентификации НКМТ
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен для аутентификации

  responses:
    CorsHeaders:
      description: CORS заголовки для кросс-доменных запросов
      headers:
        Access-Control-Allow-Origin:
          schema:
            type: string
          example: "*"
        Access-Control-Allow-Methods:
          schema:
            type: string
          example: "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers:
          schema:
            type: string
          example: "Content-Type, Authorization, X-API-Key, X-Request-ID"
        Access-Control-Allow-Credentials:
          schema:
            type: boolean
          example: true
        Access-Control-Max-Age:
          schema:
            type: integer
          example: 86400

security:
  - apiKey: []
  - bearerAuth: []

# Добавляем CORS поддержку для всех методов
x-cors:
  enabled: true
  allow-origin: "*"
  allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
  allow-headers: "Content-Type, Authorization, X-API-Key, X-Request-ID"
  allow-credentials: true
  max-age: 86400
